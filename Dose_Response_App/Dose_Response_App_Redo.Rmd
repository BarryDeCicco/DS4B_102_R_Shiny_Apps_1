---
title: "Sales Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(shinyWidgets)
library(shinyjs)

# Core
library(tidyverse)
library(tidyquant)

# Interactive Visualizations
library(plotly)

# Modeling
library(parsnip)
library(xgboost)
library(timetk)

# Database
library(odbc)
library(RSQLite)


source("04_demand_forecast.r")
```

```{css}
.bootstrap-switch .bootstrap-switch-handle-on,
.bootstrap-switch .bootstrap-switch-handle-off,
.bootstrap-switch .bootstrap-switch-label {
    display: inline-block;
    vertical-align: baseline;
}
``` 



```{r dose-response-workshop-import-csv, eval=TRUE}

# if running as an .R file:
# Data <- read.csv("Dose_Response_App/data.csv", header = TRUE)

# When running as shiny:
Data <- read.csv("data.csv", header = TRUE)

# class(Data)
# names(Data)
# sapply(Data, class) 

```


```{R dose-response-workshop-run-ANOVA-get-p-values}

# Run ANOVA and Extract P-values

Data$Drug = as.character(Data$Drug)
Data$Drug = tolower(Data$Drug)
DRUG.NAME = data.frame(unique(Data$Drug))
Drugs_cov = DRUG.NAME
names(Drugs_cov) = c("DRUG.NAME")
Drugs_cov$DRUG.NAME = as.character(Drugs_cov$DRUG.NAME)

for (name in Drugs_cov$DRUG.NAME){
     data = subset(Data, Drug == name)
#	   print(summary(aov(lm(Data$Response ~ Data$CONCEN.uM))))
	   Drugs_cov$pvalue[Drugs_cov$DRUG.NAME == name] = 
	       unlist(summary(aov(lm(Data$Response ~ Data$CONCEN.uM))))[9]} 

for (name in Drugs_cov$DRUG.NAME){
      Drugs_cov$pvaluecut[Drugs_cov$DRUG.NAME == name] = 
          ifelse(Drugs_cov$pvalue[Drugs_cov$DRUG.NAME == name] <= 0.01, "p <= 0.01", "p > 0.01")}

```


Column {.sidebar}
---------------------------------------------------------------

```{r}
useShinyjs(rmd = TRUE)


shinyWidgets::pickerInput(
  inputId  = "picker_drug_name", 
  label    = h4("Drug Name"), 
  choices  = unique(Drugs_cov$DRUG.NAME) %>% sort(), 
  selected = unique(Drugs_cov$DRUG.NAME) %>% sort() %>% first(), 
  multiple = FALSE,
  options  = list(
    `actions-box` = TRUE,
    size = 10,
    `selected-text-format` = "count > 3"
  )
)




# APPLY BUTTONS ------

br()
hr()
br()

actionButton(inputId = "apply", label = "Apply", icon = icon("play"))

actionButton(inputId = "reset", label = "Reset", icon = icon("sync"))

```



```{r dose-response-workshop-filter-data, eval=TRUE}

dataagg <- eventReactive(
  eventExpr = input$apply, 
                                             
  valueExpr = {

    data <- Data %>% filter(Drug %in% input$picker_drug_name)  
        
    # data <- Data %>% filter(Drug %in% input$picker_drug_name) %>% 
    #     dplyr::group_by(CONCEN.uM) %>% 
    #     dplyr::summarise(MEAN = mean(Response,na.rm = T),
    #                      SD = SD(Response,na.rm = T)
    #                      )
      
      # dataagg_temp = cbind(aggregate(data$Response, 
      #               by = list(data$CONCEN.uM), FUN = mean, na.rm = T), 
      #               aggregate(data$Response, 
      #               by = list(data$CONCEN.uM), FUN = sd, na.rm = T)$x)
      # 
      # names(dataagg_temp) = c("CONCEN.uM", "MEAN", "SD")
  },
  ignoreNULL = FALSE
)

# View(dataagg)




```


Row {data-height=150}
---------------------------------------------------------------

```{r, eval=FALSE}
summary_values_tbl <- reactive({
  
  processed_data_filtered_tbl() %>%
  
    summarize(
      health_metric = unique(order.id) %>% length(),
      wealth_metric = sum(extended_price),
      wise_metric   = (sum(str_detect(category_1, "Mountain")) / (sum(str_detect(category_1, "Road")) + 0.0001)) %>% 
        round(1)
    ) 
    # %>%
    # mutate(
    #   health_metric = health_metric %>% scales::number(big.mark = ","),
    #   wealth_metric = wealth_metric %>% scales::dollar(scale = 1e-6, accuracy = 0.1, suffix = "M")
    # )
  
})

# renderPrint(summary_values_tbl())

```


### Health

```{r, eval=FALSE}
renderValueBox({
  
  valueBox(
    value   = summary_values_tbl()$health_metric %>% scales::comma(), 
    caption = "Orders", 
    icon    = "fa-heartbeat", 
    color   = case_when(summary_values_tbl()$health_metric < 200 ~ "danger",
                        summary_values_tbl()$health_metric < 500 ~ "warning",
                        TRUE ~ "success"))
  
})


```


### Wealthy

```{r, eval=FALSE}
renderValueBox({
  
  valueBox(
    value   = summary_values_tbl()$wealth_metric%>% 
        scales::dollar(scale = 1E-6, suffix = "M", accuracy = 0.1),  
    caption = "Sales", 
    icon    = "fa-money-check-alt", 
    color   = case_when(summary_values_tbl()$wealth_metric < 5e6 ~ "danger",
                        summary_values_tbl()$wealth_metric < 50e6 ~ "warning",
                        TRUE ~ "success"))
  
})
```


### Wise

```{r, eval=FALSE}
renderValueBox({
  
  valueBox(
    value   = summary_values_tbl()$wise_metric, 
    caption = "Ratio, Mountain to Road", 
    icon    = "fa-brain", 
    color   = case_when(summary_values_tbl()$wise_metric < 0.5  ~ "warning",
                        summary_values_tbl()$wise_metric < 2.0   ~ "success",
                        TRUE ~ "warning"))
  
})
```


Row {data-height=850}
---------------------------------------------------------------

### Error Bar Plot

```{r, eval=FALSE}

geo_plot_tbl <- reactive({

  processed_data_filtered_tbl() %>%

    group_by(state) %>%
    summarise(total_revenue = sum(extended_price)) %>%
    ungroup() %>%
    mutate(label_text = str_glue("State: {state}
                                 Revenue: {scales::dollar(total_revenue)}"))

})


# geo_plot_tbl <- processed_data_tbl %>%
#     group_by(state) %>%
#     summarise(total_revenue = sum(extended_price)) %>%
#     ungroup() %>%
#     mutate(label_text = str_glue("State: {state}
#                                  Revenue: {scales::dollar(total_revenue)}"))
```


```{r, eval=FALSE}
output$plotly_1 <- renderPlotly(expr = {
  
  geo_plot_tbl() %>%
    plot_geo(locationmode = "USA-states") %>%
    add_trace(z         = ~total_revenue, 
              locations = ~state, 
              color     = ~total_revenue,
              text      = ~label_text,
              colors    = "Blues") %>%
    layout(
        geo = list(
            scope = "usa",
            projection = list(type = "albers usa"),
            showlakes  = TRUE,
            lakecolor  = toRGB("white")
        )
    )
  
})

plotlyOutput(outputId = "plotly_1")

```

```{r dose-response-workshop-print-filtered-aggregated-data, eval=FALSE}

dataagg_tbl <- reactive({
  
    
    print(data)
   # data %>% dplyr::group_by(CONCEN.uM) %>% 
   #       dplyr::summarise(MEAN = mean(Response,na.rm = T),
   #                        SD = SD(Response,na.rm = T)
   #                        )

    
})

renderPrint(dataagg_tbl())


```


```{r dose-response-workshop-print-filtered-aggregated-data-II, eval=TRUE}

dataagg_tbl <- reactive({
  
    
   
   data <- Data %>% dplyr::filter(Drug == input$picker_drug_name) %>% 
        dplyr::group_by(CONCEN.uM) %>%                             
           dplyr::summarise(MEAN = mean(Response,na.rm = T),
                            SD = sd(Response,na.rm = T)
                            )
   print(data)
  
   
})

# renderPrint(dataagg_tbl())


```



```{r dose-response-workshop-error-bar-plot, eval=TRUE}
output$plotly_1 <- renderPlotly(expr = {
 
errorbar_title = paste0("Plot with Error Bars:  Drug = ",input$picker_drug_name)
    
    dataagg_tbl() %>% ggplot(., aes(x = round(CONCEN.uM,2), y = MEAN)) + 
        scale_x_continuous(name = "CONCEN.uM", trans='log') +
        geom_errorbar(aes(ymin = MEAN - SD, ymax = MEAN + SD), width = .1, color = "green") +
        geom_line(color = "green") + geom_point(color = "green") + 
        theme_bw() + 
        theme_classic() +
        labs(title=errorbar_title,
        x ="Concentration (uM, log scale)", y = "Mean Response")
    
    
  # geo_plot_tbl() %>%
  #   plot_geo(locationmode = "USA-states") %>%
  #   add_trace(z         = ~total_revenue, 
  #             locations = ~state, 
  #             color     = ~total_revenue,
  #             text      = ~label_text,
  #             colors    = "Blues") %>%
  #   layout(
  #       geo = list(
  #           scope = "usa",
  #           projection = list(type = "albers usa"),
  #           showlakes  = TRUE,
  #           lakecolor  = toRGB("white")
  #       )
  #   )
  
})

plotlyOutput(outputId = "plotly_1")

```



### Scatterplot of Response vs Dose


```{r time-series-plot, eval=FALSE}
time_plot_tbl <- reactive({
  
  processed_data_filtered_tbl() %>%
      aggregate_time_series(time_unit = input$time_unit)

})
  
time_plot_predictions_tbl <- eventReactive(eventExpr = input$apply, {
    if(input$forecast_mode){
        time_plot_tbl() %>% 
            generate_forecast(n_future = input$n_future, seed = 123)
    }
    
    
})


# renderPrint(time_plot_predictions_tbl())

output$plotly_2 <- renderPlotly({

  if(input$forecast_mode){
    p <-   time_plot_predictions_tbl() %>% 
           plot_forecast()
  } else {
    p <-   time_plot_tbl() %>% 
       plot_time_series()
  }

# pipr the plot into a layout command, to set the margins better:    

    p %>% layout(margin = list(b = 200))
    
})

plotlyOutput(outputId = "plotly_2")
  
```


```{r prepare-data-for-scatterplot-dose-response, eval=TRUE}

scatterplot_tbl <- reactive({

     data <- Data %>% dplyr::filter(Drug == input$picker_drug_name) 

     print(data)
})




# renderPrint(scatterplot_tbl())


  
```



```{r plot-scatterplot-dose-response-data, eval=TRUE}



output$plotly_2 <- renderPlotly({

scatterplot_title = paste0("Scatter Plot of Dose and Response:  Drug = ", input$picker_drug_name)
    
    scatterplot_tbl() %>% ggplot(., aes(x = round(CONCEN.uM,2), y = Response)) + 
        scale_x_continuous(name = "CONCEN.uM", trans='log') +
        geom_point() +
        theme_bw() + 
        theme_classic() +
        labs(title=scatterplot_title,
        x ="Concentration (uM, log scale)", y = "Response")

})

plotlyOutput(outputId = "plotly_2")
  
```